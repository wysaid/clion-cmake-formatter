# Release workflow for publishing to VS Code Marketplace, npm, and creating GitHub Releases
#
# Publishing Rules:
# 1. v?X.Y.Z: Stable release â†’ Publish VS Code + CLI + Core to respective platforms, create GitHub Release
# 2. v?X.Y.Z-<suffix>: Pre-release â†’ Pre-publish VS Code + CLI + Core to respective platforms, create GitHub Release
# 3. Manual trigger: Dry-run mode â†’ Build, test, archive VSIX (no publishing)
# 4. cli.X.Y.Z: CLI dry-run â†’ Build, test, archive VSIX (no publishing)
# 5. core.X.Y.Z: Core dry-run â†’ Build, test, archive VSIX (no publishing)
# 6. vsc.X.Y.Z: VS Code dry-run â†’ Build, test, archive VSIX (no publishing)
#
# Note:
# - Master branch pushes trigger dry-run mode (archive only, 30 days retention)
# - npm publishing requires NPM_STORE_TOKEN secret; if not configured, npm steps are skipped
# - Package-specific tags (cli.*, core.*, vsc.*) only archive to Actions (90 days retention)
#
# Tag format examples:
# - v1.4.1, 1.4.1 â†’ Publish VS Code + npm (stable)
# - v1.4.1-alpha, v1.4.1-rc â†’ Publish VS Code + npm (pre-release)
# - cli.1.4.1 â†’ Archive only (dry-run)
# - core.1.4.1 â†’ Archive only (dry-run)
# - vsc.1.4.1 â†’ Archive only (dry-run)
name: Release

on:
  push:
    tags:
      - '*'
    branches:
      - master
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.4.1, 1.4.1-beta). Manual triggers will NOT publish.'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Determine trigger type
      id: trigger_type
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # Manual trigger - always dry-run
          echo "is_tag=false" >> $GITHUB_OUTPUT
          echo "is_dry_run=true" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT
          TAG="${{ github.event.inputs.tag }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Triggered manually with tag: $TAG (dry-run mode - will NOT publish)"
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # Tag push
          echo "is_tag=true" >> $GITHUB_OUTPUT
          echo "is_dry_run=false" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Triggered by tag push: $TAG"
        else
          # Master branch push - always dry-run
          echo "is_tag=false" >> $GITHUB_OUTPUT
          echo "is_dry_run=true" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT
          # Use sed instead of node to avoid dependency on Node.js before setup
          PACKAGE_VERSION=$(sed -n 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' package.json)
          echo "tag=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Triggered by master branch push (dry-run mode)"
          echo "Using version from package.json: $PACKAGE_VERSION"
        fi

    - name: Validate tag format and determine release type
      id: validate_tag
      run: |
        TAG="${{ steps.trigger_type.outputs.tag }}"
        IS_DRY_RUN="${{ steps.trigger_type.outputs.is_dry_run }}"
        IS_MANUAL="${{ steps.trigger_type.outputs.is_manual }}"

        # Initialize outputs
        echo "is_stable_release=false" >> $GITHUB_OUTPUT
        echo "is_prerelease=false" >> $GITHUB_OUTPUT
        echo "should_publish=false" >> $GITHUB_OUTPUT
        echo "should_publish_npm=false" >> $GITHUB_OUTPUT
        echo "is_cli_tag=false" >> $GITHUB_OUTPUT
        echo "is_core_tag=false" >> $GITHUB_OUTPUT
        echo "is_vscode_tag=false" >> $GITHUB_OUTPUT

        # Check for package-specific tags (cli.X.Y.Z, core.X.Y.Z, vsc.X.Y.Z)
        if echo "$TAG" | grep -qE '^cli\.[0-9]+\.[0-9]+\.[0-9]+(-.*)?$'; then
          echo "is_cli_tag=true" >> $GITHUB_OUTPUT
          echo "CLI package tag detected: $TAG"
          echo "Will build and archive CLI package + VSIX (no marketplace publish)"
          # CLI tags never publish to marketplace, just archive
        elif echo "$TAG" | grep -qE '^core\.[0-9]+\.[0-9]+\.[0-9]+(-.*)?$'; then
          echo "is_core_tag=true" >> $GITHUB_OUTPUT
          echo "Core package tag detected: $TAG"
          echo "Will build and archive VSIX (no marketplace publish)"
          # Core tags never publish to marketplace, just archive
        elif echo "$TAG" | grep -qE '^vsc\.[0-9]+\.[0-9]+\.[0-9]+(-.*)?$'; then
          echo "is_vscode_tag=true" >> $GITHUB_OUTPUT
          # vsc.X.Y.Z tags are always dry-run (archive only, no publish)
          echo "should_publish=false" >> $GITHUB_OUTPUT
          echo "VS Code extension tag detected (dry-run): $TAG"
          echo "Will build and archive VSIX (no marketplace publish)"
          # Check if it's a pre-release for metadata purposes
          if echo "$TAG" | grep -qE '^vsc\.[0-9]+\.[0-9]+\.[0-9]+-.+$'; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_stable_release=true" >> $GITHUB_OUTPUT
          fi
        else
          # Remove 'v' prefix for legacy pattern matching
          TAG_WITHOUT_V="${TAG#v}"

          # Check if tag matches stable release pattern (e.g., v1.0.3, 1.0.3)
          if echo "$TAG_WITHOUT_V" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "is_stable_release=true" >> $GITHUB_OUTPUT
            echo "is_vscode_tag=true" >> $GITHUB_OUTPUT

            # Manual triggers never publish
            if [ "$IS_MANUAL" == "true" ]; then
              echo "should_publish=false" >> $GITHUB_OUTPUT
              echo "should_publish_npm=false" >> $GITHUB_OUTPUT
              echo "Manual trigger: Tag matches stable release pattern but will NOT publish (dry-run): $TAG"
            elif [ "$IS_DRY_RUN" == "true" ]; then
              echo "should_publish=false" >> $GITHUB_OUTPUT
              echo "should_publish_npm=false" >> $GITHUB_OUTPUT
              echo "Dry-run: Tag matches stable release pattern: $TAG"
            else
              echo "should_publish=true" >> $GITHUB_OUTPUT
              echo "should_publish_npm=true" >> $GITHUB_OUTPUT
              echo "Tag matches stable release pattern, will publish to VS Code Marketplace and npm: $TAG"
            fi
          # Check if tag matches pre-release pattern (e.g., v1.0.3-alpha, 1.0.3-beta, 1.0.3-rc.1)
          elif echo "$TAG_WITHOUT_V" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-.+$'; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "is_vscode_tag=true" >> $GITHUB_OUTPUT

            # Manual triggers never publish
            if [ "$IS_MANUAL" == "true" ]; then
              echo "should_publish=false" >> $GITHUB_OUTPUT
              echo "should_publish_npm=false" >> $GITHUB_OUTPUT
              echo "Manual trigger: Tag matches pre-release pattern but will NOT publish (dry-run): $TAG"
            elif [ "$IS_DRY_RUN" == "true" ]; then
              echo "should_publish=false" >> $GITHUB_OUTPUT
              echo "should_publish_npm=false" >> $GITHUB_OUTPUT
              echo "Dry-run: Tag matches pre-release pattern: $TAG"
            else
              echo "should_publish=true" >> $GITHUB_OUTPUT
              echo "should_publish_npm=true" >> $GITHUB_OUTPUT
              echo "Tag matches pre-release pattern, will publish to VS Code Marketplace and npm: $TAG"
            fi
          else
            if [ "$IS_MANUAL" == "true" ]; then
              echo "Manual trigger: Tag does not match release patterns (dry-run): $TAG"
            elif [ "$IS_DRY_RUN" == "true" ]; then
              echo "Dry-run: Tag does not match release patterns: $TAG"
            else
              echo "Tag does not match release patterns, will NOT publish: $TAG"
            fi
            echo "Will only run build and test."
          fi
        fi

    - name: Extract version from tag
      id: extract_version
      if: steps.validate_tag.outputs.should_publish == 'true' || steps.validate_tag.outputs.is_cli_tag == 'true' || steps.validate_tag.outputs.is_core_tag == 'true' || steps.validate_tag.outputs.is_vscode_tag == 'true'
      run: |
        TAG="${{ steps.trigger_type.outputs.tag }}"

        # Handle package-specific tags (cli.X.Y.Z, core.X.Y.Z, vsc.X.Y.Z)
        if echo "$TAG" | grep -qE '^(cli|core|vsc)\.[0-9]'; then
          # Extract version from package tag (e.g., cli.1.4.1 -> 1.4.1)
          VERSION=$(echo "$TAG" | sed 's/^[^.]*\.//' | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')
        else
          # Remove 'v' prefix if present, then extract the version number
          # (e.g., 1.0.3 from v1.0.3, 1.0.3, v1.0.3-alpha, or 1.0.3-alpha)
          TAG_WITHOUT_V="${TAG#v}"
          VERSION=$(echo "$TAG_WITHOUT_V" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    # Version validation: Tag base version (e.g., 1.0.3 from 1.0.3-alpha) must match package.json version
    # This applies to both stable releases and pre-releases
    # For VS Code extension tags, check vscode package.json
    # For CLI tags, check cli package.json
    # For core tags, check core package.json
    - name: Check version consistency with package.json
      if: (steps.validate_tag.outputs.should_publish == 'true' || steps.validate_tag.outputs.is_cli_tag == 'true' || steps.validate_tag.outputs.is_core_tag == 'true' || steps.validate_tag.outputs.is_vscode_tag == 'true') && steps.trigger_type.outputs.is_tag == 'true'
      run: |
        TAG_VERSION="${{ steps.extract_version.outputs.version }}"

        # Determine which package.json to check based on tag type
        if [ "${{ steps.validate_tag.outputs.is_cli_tag }}" == "true" ]; then
          PACKAGE_JSON="packages/cli/package.json"
          PACKAGE_NAME="CLI"
        elif [ "${{ steps.validate_tag.outputs.is_core_tag }}" == "true" ]; then
          PACKAGE_JSON="packages/core/package.json"
          PACKAGE_NAME="Core"
        else
          PACKAGE_JSON="packages/vscode/package.json"
          PACKAGE_NAME="VS Code Extension"
        fi

        PACKAGE_VERSION=$(node -p "require('./${PACKAGE_JSON}').version")

        echo "Tag version: $TAG_VERSION"
        echo "${PACKAGE_NAME} package.json version: $PACKAGE_VERSION"

        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "Error: Tag version ($TAG_VERSION) does not match ${PACKAGE_NAME} package.json version ($PACKAGE_VERSION)"
          exit 1
        fi

        echo "Version check passed: $TAG_VERSION"

    - name: Compile TypeScript
      run: pnpm run compile

    - name: Run Linter
      run: pnpm run lint

    - name: Run Tests
      run: pnpm run test:unit

    - name: Build VSIX
      run: pnpm run package:vscode

    - name: Check if version exists in VS Code Marketplace
      id: check_marketplace
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true'
      continue-on-error: true
      run: |
        EXTENSION_ID="wysaid.clion-cmake-format"
        VERSION="${{ steps.extract_version.outputs.version }}"

        echo "Checking if version $VERSION exists in VS Code Marketplace..."

        # Query the marketplace API
        RESPONSE=$(curl -s -f "https://marketplace.visualstudio.com/_apis/public/gallery/extensionquery" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json;api-version=3.0-preview.1" \
          -d "{\"filters\":[{\"criteria\":[{\"filterType\":7,\"value\":\"$EXTENSION_ID\"}]}],\"flags\":914}" || echo "")

        if [ -z "$RESPONSE" ]; then
          echo "âš ï¸ Warning: Could not query marketplace API"
          echo "exists=false" >> $GITHUB_OUTPUT
        else
          # Check if the specific version exists by inspecting the extension versions array using jq
          if echo "$RESPONSE" | jq -e --arg version "$VERSION" \
            '.results[0].extensions[0].versions[].version | select(. == $version)' >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Warning: Version $VERSION already exists in VS Code Marketplace"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ“ Version $VERSION does not exist in VS Code Marketplace"
          fi
        fi

    - name: Warn if version exists (dry-run)
      if: steps.trigger_type.outputs.is_dry_run == 'true' && steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.check_marketplace.outputs.exists == 'true'
      run: |
        echo "::warning::Version ${{ steps.extract_version.outputs.version }} already exists in VS Code Marketplace. If you create a tag for this version, the marketplace publish will be skipped."

    - name: Publish to VS Code Marketplace
      id: publish_marketplace
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.trigger_type.outputs.is_dry_run == 'false' && steps.check_marketplace.outputs.exists == 'false'
      continue-on-error: true
      env:
        VSCE_PAT: ${{ secrets.MS_STORE_TOKEN }}
      run: |
        if [ "${{ steps.validate_tag.outputs.is_stable_release }}" == "true" ]; then
          echo "Publishing as stable release to VS Code Marketplace..."
          npx vsce publish 2>&1 | tee publish_output.txt
          EXIT_CODE=$?
        else
          echo "Publishing as pre-release to VS Code Marketplace..."
          npx vsce publish --pre-release 2>&1 | tee publish_output.txt
          EXIT_CODE=$?
        fi
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        exit $EXIT_CODE

    - name: Skip publish if version exists
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.trigger_type.outputs.is_dry_run == 'false' && steps.check_marketplace.outputs.exists == 'true'
      run: |
        echo "::warning::Version ${{ steps.extract_version.outputs.version }} already exists in VS Code Marketplace. Skipping marketplace publish."

    - name: Check marketplace publish result
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.trigger_type.outputs.is_dry_run == 'false' && steps.publish_marketplace.outcome != 'skipped'
      run: |
        if [ "${{ steps.publish_marketplace.outcome }}" == "failure" ]; then
          echo "::error::Failed to publish to VS Code Marketplace."
          if [ -f publish_output.txt ]; then
            echo "Error details:"
            cat publish_output.txt
          fi
          exit 1
        else
          echo "âœ“ Successfully published to VS Code Marketplace"
        fi

    - name: Upload VSIX as artifact (dry-run)
      if: steps.trigger_type.outputs.is_dry_run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: clion-cmake-format-${{ steps.trigger_type.outputs.tag }}
        path: "packages/vscode/*.vsix"
        retention-days: 30

    - name: Upload VSIX as artifact (CLI/Core tags)
      if: (steps.validate_tag.outputs.is_cli_tag == 'true' || steps.validate_tag.outputs.is_core_tag == 'true') && steps.trigger_type.outputs.is_dry_run == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: clion-cmake-format-${{ steps.trigger_type.outputs.tag }}
        path: "packages/vscode/*.vsix"
        retention-days: 90

    - name: Upload VSIX as artifact (vsc.X.Y.Z tags - dry-run)
      if: steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.validate_tag.outputs.should_publish == 'false' && steps.trigger_type.outputs.is_dry_run == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: clion-cmake-format-${{ steps.trigger_type.outputs.tag }}
        path: "packages/vscode/*.vsix"
        retention-days: 90

    # Publish to npm (Core and CLI packages)
    - name: Check NPM token availability
      id: check_npm_token
      if: steps.validate_tag.outputs.should_publish_npm == 'true'
      run: |
        if [ "${{ secrets.NPM_STORE_TOKEN }}" != "" ]; then
          echo "npm_token_available=true" >> $GITHUB_OUTPUT
          echo "âœ“ NPM_STORE_TOKEN is configured"
        else
          echo "npm_token_available=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Warning: NPM_STORE_TOKEN is not configured, will skip npm publishing"
        fi

    - name: Publish Core package to npm
      if: steps.validate_tag.outputs.should_publish_npm == 'true' && steps.check_npm_token.outputs.npm_token_available == 'true'
      continue-on-error: false
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_STORE_TOKEN }}
      run: |
        # Build the Core package
        echo "Building @cc-format/core..."
        npm run build:core

        # Publish using NODE_AUTH_TOKEN (npm uses it automatically)
        cd packages/core
        if [ "${{ steps.validate_tag.outputs.is_stable_release }}" == "true" ]; then
          echo "Publishing @cc-format/core as stable release..."
          npm publish --access public
        else
          echo "Publishing @cc-format/core as pre-release (next tag)..."
          npm publish --access public --tag next
        fi

        echo "âœ“ @cc-format/core published successfully"

    - name: Publish CLI package to npm
      if: steps.validate_tag.outputs.should_publish_npm == 'true' && steps.check_npm_token.outputs.npm_token_available == 'true'
      continue-on-error: false
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_STORE_TOKEN }}
      run: |
        # Build the CLI package
        echo "Building cc-format..."
        npm run build:cli

        # Publish using NODE_AUTH_TOKEN (npm uses it automatically)
        cd packages/cli
        if [ "${{ steps.validate_tag.outputs.is_stable_release }}" == "true" ]; then
          echo "Publishing cc-format as stable release..."
          npm publish --access public
        else
          echo "Publishing cc-format as pre-release (next tag)..."
          npm publish --access public --tag next
        fi

        echo "âœ“ cc-format published successfully"

    - name: Skip npm publish (token not configured)
      if: steps.validate_tag.outputs.should_publish_npm == 'true' && steps.check_npm_token.outputs.npm_token_available == 'false'
      run: |
        echo "::warning::NPM_STORE_TOKEN is not configured. Skipping npm publishing for Core and CLI packages."
        echo "To enable npm publishing, configure the NPM_STORE_TOKEN secret in repository settings."

    # Generate comprehensive release notes including CLI and Core changes
    - name: Generate Release Notes
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.trigger_type.outputs.is_dry_run == 'false'
      id: release_notes
      run: |
        VERSION="${{ steps.extract_version.outputs.version }}"
        TAG="${{ steps.trigger_type.outputs.tag }}"
        IS_STABLE="${{ steps.validate_tag.outputs.is_stable_release }}"

        if [ "$IS_STABLE" == "true" ]; then
          echo "# ðŸŽ‰ Release ${TAG}" > release_notes.md
        else
          echo "# ðŸš€ Pre-release ${TAG}" > release_notes.md
        fi
        echo "" >> release_notes.md

        # Add VS Code extension info
        echo "## ðŸ“¦ VS Code Extension" >> release_notes.md
        echo "" >> release_notes.md
        echo "Install from [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=wysaid.clion-cmake-format) or download the VSIX file below." >> release_notes.md
        echo "" >> release_notes.md

        # Extract changelog from VS Code package
        if [ -f packages/vscode/CHANGELOG.md ]; then
          echo "### Changes" >> release_notes.md
          # Extract the section for this version (from ## [VERSION] to next ## or EOF)
          VSCODE_CHANGES=$(sed -n "/## \\[${VERSION}\\]/,/## \\[/p" packages/vscode/CHANGELOG.md | sed '$d')
          if [ -n "$VSCODE_CHANGES" ]; then
            echo "$VSCODE_CHANGES" >> release_notes.md
          else
            echo "" >> release_notes.md
            echo "_No specific changes documented for this version._" >> release_notes.md
          fi
        fi

        # Add CLI tool info
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ”§ CLI Tool" >> release_notes.md
        echo "" >> release_notes.md
        echo "The \`cc-format\` command-line tool is available on npm:" >> release_notes.md
        echo "" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "# Install globally" >> release_notes.md
        echo "npm install -g cc-format@${VERSION}" >> release_notes.md
        echo "" >> release_notes.md
        echo "# Or use with npx" >> release_notes.md
        echo "npx cc-format@${VERSION} --help" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md

        # Extract CLI changelog
        if [ -f packages/cli/CHANGELOG.md ]; then
          echo "### Changes" >> release_notes.md
          CLI_CHANGES=$(sed -n "/## \\[${VERSION}\\]/,/## \\[/p" packages/cli/CHANGELOG.md | sed '$d')
          if [ -n "$CLI_CHANGES" ]; then
            echo "$CLI_CHANGES" >> release_notes.md
          else
            echo "" >> release_notes.md
            echo "_No specific changes documented for this version._" >> release_notes.md
          fi
        fi

        # Add core library info
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ“š Core Library" >> release_notes.md
        echo "" >> release_notes.md
        echo "The \`@cc-format/core\` library is available on npm:" >> release_notes.md
        echo "" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "npm install @cc-format/core@${VERSION}" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md

        # Extract core changelog
        if [ -f packages/core/CHANGELOG.md ]; then
          echo "### Changes" >> release_notes.md
          CORE_CHANGES=$(sed -n "/## \\[${VERSION}\\]/,/## \\[/p" packages/core/CHANGELOG.md | sed '$d')
          if [ -n "$CORE_CHANGES" ]; then
            echo "$CORE_CHANGES" >> release_notes.md
          else
            echo "" >> release_notes.md
            echo "_No specific changes documented for this version._" >> release_notes.md
          fi
        fi

        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Full Changelog**: https://github.com/wysaid/clion-cmake-format/commits/${TAG}" >> release_notes.md

        cat release_notes.md

    - name: Create GitHub Release
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.validate_tag.outputs.is_vscode_tag == 'true' && steps.trigger_type.outputs.is_dry_run == 'false'
      uses: softprops/action-gh-release@v2
      with:
        files: "packages/vscode/*.vsix"
        body_path: release_notes.md
        prerelease: ${{ steps.validate_tag.outputs.is_prerelease }}
