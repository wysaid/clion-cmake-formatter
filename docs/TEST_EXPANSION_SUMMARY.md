# æµ‹è¯•æ‰©å±•å®Œæˆæ€»ç»“

## æ¦‚è¿°

æˆåŠŸä» CMake å®˜æ–¹ä»“åº“æå–å¹¶éªŒè¯äº† 20 ä¸ªæœ‰ä»£è¡¨æ€§çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæå¤§åœ°å¢å¼ºäº†æ ¼å¼åŒ–å™¨çš„æµ‹è¯•è¦†ç›–èŒƒå›´ã€‚

## å®Œæˆçš„å·¥ä½œ

### 1. å·¥å…·å¼€å‘

åˆ›å»ºäº†ä¸¤ä¸ªäº’è¡¥çš„è„šæœ¬å·¥å…·ï¼š

#### `scripts/select-cmake-tests.py` (æ™ºèƒ½é€‰æ‹©å™¨)
- **åŠŸèƒ½**: è‡ªåŠ¨åˆ†æå’Œé€‰æ‹©æµ‹è¯•æ–‡ä»¶
- **ç‰¹æ€§**:
  - å¤æ‚åº¦è¯„åˆ†ç®—æ³• (åŸºäºå‘½ä»¤æ•°ã€å‡½æ•°/å®ã€æ§åˆ¶æµ)
  - å¤šæ ·æ€§é€‰æ‹©ç­–ç•¥ (ç®€å•/ä¸­ç­‰/å¤æ‚å„ 5/8/7 ä¸ª)
  - è‡ªåŠ¨ç”Ÿæˆ README
  - Git sparse checkout ä¼˜åŒ– (åªä¸‹è½½ Tests ç›®å½•)
- **è¾“å…¥**: CMake å®˜æ–¹ä»“åº“ (~21,000 ä¸ªæ–‡ä»¶)
- **è¾“å‡º**: 20 ä¸ªç²¾é€‰æµ‹è¯•æ–‡ä»¶

#### `scripts/fetch-cmake-tests.sh` (æ‰‹åŠ¨é€‰æ‹©å™¨)
- **åŠŸèƒ½**: æ‰‹åŠ¨æµè§ˆå’Œé€‰æ‹©æµ‹è¯•æ–‡ä»¶
- **ç‰¹æ€§**:
  - 5 ç±»æµ‹è¯•ç›®å½• (basic-syntax, commands, real-world, complex, tutorial)
  - ä¿ç•™åŸå§‹ç›®å½•ç»“æ„
  - ç®€å•æ˜“ç”¨
- **ç”¨é€”**: ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æŒ‘é€‰ç‰¹å®šæ–‡ä»¶æ—¶ä½¿ç”¨

#### `scripts/test-cmake-official.js` (æ‰¹é‡æµ‹è¯•å™¨)
- **åŠŸèƒ½**: æ‰¹é‡æµ‹è¯•æ‰€æœ‰å®˜æ–¹æµ‹è¯•æ–‡ä»¶
- **ç‰¹æ€§**:
  - å¹‚ç­‰æ€§éªŒè¯ (format(format(x)) == format(x))
  - ç»Ÿè®¡ä¿¡æ¯è¾“å‡º
  - é”™è¯¯è¯¦æƒ…æŠ¥å‘Š
- **è¾“å‡º**: æµ‹è¯•é€šè¿‡ç‡å’Œè¯¦ç»†ç»Ÿè®¡

### 2. æµ‹è¯•æ•°æ®é›†

#### è·å–æº
- **ä»“åº“**: https://github.com/Kitware/CMake
- **ç›®å½•**: Tests/
- **è§„æ¨¡**: 8,899 ä¸ª CMake æ–‡ä»¶
- **æ–¹æ³•**: Git sparse checkout (åªä¸‹è½½ ~3 MBï¼Œé¿å…ä¸‹è½½æ•´ä¸ª 200+ MB ä»“åº“)

#### é€‰æ‹©ç»“æœ
ä» 8,899 ä¸ªæ–‡ä»¶ä¸­é€‰å‡º 20 ä¸ªä»£è¡¨æ€§æ–‡ä»¶ï¼š

| å¤æ‚åº¦çº§åˆ« | æ•°é‡ | è¡Œæ•°èŒƒå›´ | å¤æ‚åº¦èŒƒå›´ |
|-----------|------|---------|-----------|
| ç®€å• | 5 | 8-21 | 4-20 |
| ä¸­ç­‰ | 8 | 51-144 | 27-99 |
| å¤æ‚ | 7 | 228-3511 | 167-2504 |

#### è¦†ç›–çš„ç‰¹æ€§
- âœ… åŸºç¡€å‘½ä»¤: set, file, message, etc.
- âœ… æ§åˆ¶æµ: if/else/endif, foreach/endforeach, while/endwhile
- âœ… å‡½æ•°å’Œå®å®šä¹‰
- âœ… å¤šè¡Œå‘½ä»¤å’Œå‚æ•°
- âœ… å¤æ‚åµŒå¥—ç»“æ„
- âœ… æ³¨é‡Šå¤„ç†
- âœ… çœŸå®é¡¹ç›®ç”¨ä¾‹
- âœ… ç‰¹æ®Šè¯­æ³•: bracket arguments, bracket comments

### 3. æµ‹è¯•ç»“æœ

#### å¹‚ç­‰æ€§æµ‹è¯•
```bash
node scripts/test-cmake-official.js
```

**ç»“æœ**:
- âœ… é€šè¿‡: 20/20 (100%)
- âŒ å¤±è´¥: 0/20
- âš ï¸ é”™è¯¯: 0/20

**ç»Ÿè®¡**:
- æ€»è¡Œæ•°: 6,302 è¡Œ
- å¹³å‡æ¯æ–‡ä»¶: 315 è¡Œ
- å¤æ‚åº¦èŒƒå›´: 4-2504

#### ç¤ºä¾‹æ–‡ä»¶

**ç®€å•æ–‡ä»¶** - `FortranOnly_test_preprocess.cmake` (8 è¡Œ):
```cmake
set(TEST_FILE CMakeFiles/preprocess.dir/preprocess.F.i)
file(READ ${TEST_FILE} CONTENTS)
if("${CONTENTS}" MATCHES "PRINT *")
  message(STATUS "${TEST_FILE} created successfully!")
else()
  message(FATAL_ERROR "${TEST_FILE} creation failed!")
endif()
```

**ä¸­ç­‰å¤æ‚** - `RunCMake_FetchContent_DirOverrides.cmake` (70 è¡Œ):
- FetchContent å‘½ä»¤æµ‹è¯•
- ç›®å½•è¦†ç›–é€»è¾‘
- é”™è¯¯å¤„ç†

**é«˜åº¦å¤æ‚** - `CMakeLists.txt` (3,511 è¡Œ):
- CMake è‡ªå·±çš„ä¸»æµ‹è¯•æ–‡ä»¶
- åŒ…å«æ‰€æœ‰ CMake ç‰¹æ€§
- å¤æ‚åº¦è¯„åˆ†: 2504

### 4. æ–‡æ¡£æ›´æ–°

#### æ–°å¢æ–‡æ¡£
- `docs/EXTENDING_TESTS.md` - å®Œæ•´çš„æµ‹è¯•æ‰©å±•æŒ‡å—
  - CMake å®˜æ–¹èµ„æºä»‹ç»
  - ä¸¤ç§é€‰æ‹©æ–¹æ³• (è‡ªåŠ¨/æ‰‹åŠ¨)
  - é›†æˆåˆ°æµ‹è¯•å¥—ä»¶çš„æ­¥éª¤
  - æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹

#### æ›´æ–°æ–‡æ¡£
- `README.md` - æ·»åŠ æµ‹è¯•è¦†ç›–éƒ¨åˆ† (è‹±æ–‡)
- `README.zh-CN.md` - æ·»åŠ æµ‹è¯•è¦†ç›–éƒ¨åˆ† (ä¸­æ–‡)
- `test/datasets/cmake-official/README.md` - è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶è¯´æ˜

### 5. é¡¹ç›®ç»“æ„å˜åŒ–

```
clion-cmake-formatter/
â”œâ”€â”€ scripts/                     [æ–°å¢]
â”‚   â”œâ”€â”€ fetch-cmake-tests.sh     # Bash æ‰‹åŠ¨é€‰æ‹©å™¨
â”‚   â”œâ”€â”€ select-cmake-tests.py    # Python æ™ºèƒ½é€‰æ‹©å™¨
â”‚   â””â”€â”€ test-cmake-official.js   # Node.js æ‰¹é‡æµ‹è¯•å™¨
â”œâ”€â”€ test/
â”‚   â””â”€â”€ datasets/
â”‚       â””â”€â”€ cmake-official/      [æ–°å¢] - 20 ä¸ªæµ‹è¯•æ–‡ä»¶
â””â”€â”€ docs/
    â””â”€â”€ EXTENDING_TESTS.md       [æ–°å¢] - æµ‹è¯•æ‰©å±•æŒ‡å—
```

## æµ‹è¯•è¦†ç›–å¯¹æ¯”

### ä¹‹å‰
- 8 ä¸ª well-formatted æµ‹è¯•æ–‡ä»¶
- çº¦ 1,500 è¡Œæµ‹è¯•ä»£ç 
- ä¸»è¦è¦†ç›–åŸºç¡€ç‰¹æ€§

### ä¹‹å
- 8 ä¸ª well-formatted + 20 ä¸ªå®˜æ–¹æµ‹è¯•æ–‡ä»¶
- çº¦ 7,800 è¡Œæµ‹è¯•ä»£ç  (+420%)
- è¦†ç›– CMake å®˜æ–¹ä½¿ç”¨çš„æ‰€æœ‰ä¸»è¦ç‰¹æ€§
- åŒ…å«çœŸå®ä¸–ç•Œå¤æ‚ç”¨ä¾‹

## æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½å¤æ‚åº¦è¯„åˆ†
```python
complexity = (
    commands +
    functions * 2 +
    macros * 2 +
    if_blocks +
    loops
)
```

### 2. å¤šæ ·æ€§é€‰æ‹©ç®—æ³•
- æŒ‰å¤æ‚åº¦åˆ†å±‚ (ç®€å•/ä¸­ç­‰/å¤æ‚)
- æ¯å±‚æŒ‰æ–‡ä»¶å¤§å°æ’åº
- å‡åŒ€é‡‡æ ·ï¼Œé¿å…é‡å¤

### 3. Sparse Checkout ä¼˜åŒ–
```bash
git clone --depth 1 --filter=blob:none --sparse
git sparse-checkout set Tests/
```
- åªä¸‹è½½éœ€è¦çš„ç›®å½•
- å‡å°‘ ~97% çš„ä¸‹è½½é‡ (3 MB vs 200+ MB)

### 4. å®æ—¶è¿›åº¦åé¦ˆ
```
[1/20] BootstrapTest.cmake... âœ… PASS
[2/20] CMakeLists.txt... âœ… PASS
...
```

## éªŒè¯æ–¹æ³•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
# å•å…ƒæµ‹è¯• (107 ä¸ª)
npm run test:unit

# CMake å®˜æ–¹æµ‹è¯• (20 ä¸ª)
node scripts/test-cmake-official.js

# ç¼–è¯‘æ£€æŸ¥
npm run compile

# Lint æ£€æŸ¥
npm run lint
```

### å•æ–‡ä»¶æµ‹è¯•
```bash
node -e "
const {formatCMake} = require('./dist/src/formatter');
const fs = require('fs');
const file = 'test/datasets/cmake-official/BootstrapTest.cmake';
const content = fs.readFileSync(file, 'utf-8');
const f1 = formatCMake(content, {});
const f2 = formatCMake(f1, {});
console.log(f1 === f2 ? 'PASS' : 'FAIL');
"
```

## æœªæ¥æ”¹è¿›

### æ½œåœ¨æ‰©å±•
1. **æ›´å¤šæµ‹è¯•é›†**:
   - æ·»åŠ ç¤¾åŒºæµè¡Œé¡¹ç›® (LLVM, Boost, Qt)
   - æ”¶é›†ç”¨æˆ·æŠ¥å‘Šçš„è¾¹ç•Œæƒ…å†µ

2. **è‡ªåŠ¨åŒ–æµ‹è¯•**:
   - åœ¨ CI ä¸­è¿è¡Œ `test-cmake-official.js`
   - å®šæœŸæ›´æ–°å®˜æ–¹æµ‹è¯•é›† (æ¯ä¸ª CMake å‘å¸ƒç‰ˆæœ¬)

3. **æ€§èƒ½æµ‹è¯•**:
   - å¤§æ–‡ä»¶æ ¼å¼åŒ–æ€§èƒ½ (å¦‚ 3,511 è¡Œçš„ CMakeLists.txt)
   - æ‰¹é‡æ–‡ä»¶æ ¼å¼åŒ–

4. **å›å½’æµ‹è¯•**:
   - ä¿å­˜å½“å‰æ ¼å¼åŒ–è¾“å‡ºä½œä¸ºå¿«ç…§
   - æ£€æµ‹æ„å¤–çš„æ ¼å¼åŒ–è¡Œä¸ºå˜åŒ–

### æµ‹è¯•ç­–ç•¥
- **Well-formatted**: éªŒè¯å¹‚ç­‰æ€§ (format(format(x)) == format(x))
- **Official tests**: éªŒè¯çœŸå®é¡¹ç›®å…¼å®¹æ€§
- **Unit tests**: éªŒè¯ç‰¹å®šåŠŸèƒ½æ­£ç¡®æ€§
- **Edge cases**: éªŒè¯è¾¹ç•Œæƒ…å†µå¤„ç†

## è´¡çŒ®è€…æŒ‡å—

### æ·»åŠ æ–°æµ‹è¯•æ–‡ä»¶
1. å°†æ–‡ä»¶å¤åˆ¶åˆ° `test/datasets/cmake-official/`
2. è¿è¡Œ `node scripts/test-cmake-official.js` éªŒè¯
3. å¦‚æœé€šè¿‡ï¼Œæäº¤å¹¶è¯´æ˜æµ‹è¯•è¦†ç›–çš„ç‰¹æ€§

### æŠ¥å‘Šæ ¼å¼åŒ–é—®é¢˜
1. æä¾›åŸå§‹ CMake æ–‡ä»¶
2. è¯´æ˜é¢„æœŸè¾“å‡º
3. åŒ…å«é…ç½®æ–‡ä»¶ (å¦‚æœä½¿ç”¨)
4. è¿è¡Œ `npm run test:unit` ç¡®è®¤é—®é¢˜

## æ€»ç»“

âœ… **å®Œå…¨è¾¾æˆç›®æ ‡**:
- æµ‹è¯•è¦†ç›–å¢åŠ  420%
- 100% é€šè¿‡å¹‚ç­‰æ€§æµ‹è¯•
- å®Œæ•´çš„å·¥å…·é“¾å’Œæ–‡æ¡£
- çœŸå®ä¸–ç•Œç”¨ä¾‹éªŒè¯

ğŸ¯ **è´¨é‡ä¿è¯**:
- æ‰€æœ‰ CMake å®˜æ–¹æµ‹è¯•æ–‡ä»¶æ ¼å¼åŒ–åä¿æŒå¹‚ç­‰
- æ— ç¼–è¯‘æˆ– lint é”™è¯¯
- è¯¦ç»†çš„ç»Ÿè®¡å’ŒéªŒè¯

ğŸ“š **æ–‡æ¡£å®Œå–„**:
- ç”¨æˆ·æŒ‡å—
- å¼€å‘è€…æŒ‡å—
- è‡ªåŠ¨åŒ–è„šæœ¬
- æœ€ä½³å®è·µ

---

**æ—¥æœŸ**: 2025-12-12
**æµ‹è¯•é›†ç‰ˆæœ¬**: CMake master (latest)
**å·¥å…·ç‰ˆæœ¬**:
- Python 3.x
- Node.js 18.x-23.x
- Git 2.x
